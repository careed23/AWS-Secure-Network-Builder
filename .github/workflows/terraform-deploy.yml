# .github/workflows/terraform-deploy.yml

name: Terraform Deploy to Dev

on:
  push:
    branches:
      - main
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform-deploy.yml'

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-west-2'
  ENVIRONMENT: 'dev'

# Ensure only one deployment runs at a time
concurrency:
  group: terraform-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # -----------------------------------
  # Security Gate
  # -----------------------------------
  security_gate:
    name: 'Pre-Deploy Security Scan'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: false
          minimum_severity: HIGH

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: false
          check: HIGH
          skip_check: CKV_AWS_144

  # -----------------------------------
  # Deploy to Dev Environment
  # -----------------------------------
  deploy_dev:
    name: 'Deploy to Dev'
    runs-on: ubuntu-latest
    needs: security_gate
    environment:
      name: dev
      url: https://console.aws.amazon.com/vpc
    permissions:
      contents: read
      id-token: write
    outputs:
      vpc_id: ${{ steps.apply.outputs.vpc_id }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
         # aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions_TerraformDeploy

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=aws-secure-network/${{ env.ENVIRONMENT }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}"

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -out=tfplan \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -var="project_name=aws-secure-network"

      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -auto-approve tfplan
          
          # Capture outputs
          echo "vpc_id=$(terraform output -raw vpc_id 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT

      - name: Post Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VPC ID | ${{ steps.apply.outputs.vpc_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed By | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

  # -----------------------------------
  # Post-Deployment Validation
  # -----------------------------------
  validate_deployment:
    name: 'Validate Deployment'
    runs-on: ubuntu-latest
    needs: deploy_dev
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate VPC Exists
        run: |
          VPC_ID="${{ needs.deploy_dev.outputs.vpc_id }}"
          if [ "$VPC_ID" != "N/A" ] && [ -n "$VPC_ID" ]; then
            echo "Validating VPC: $VPC_ID"
            VPC_STATE=$(aws ec2 describe-vpcs --vpc-ids "$VPC_ID" --query 'Vpcs[0].State' --output text)
            echo "VPC State: $VPC_STATE"
            if [ "$VPC_STATE" != "available" ]; then
              echo "ERROR: VPC is not in available state"
              exit 1
            fi
          else
            echo "VPC ID not available, skipping validation"
          fi

      - name: Validate Subnets
        run: |
          VPC_ID="${{ needs.deploy_dev.outputs.vpc_id }}"
          if [ "$VPC_ID" != "N/A" ] && [ -n "$VPC_ID" ]; then
            echo "Checking subnets in VPC: $VPC_ID"
            SUBNET_COUNT=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPC_ID" --query 'length(Subnets)' --output text)
            echo "Found $SUBNET_COUNT subnets"
          fi

      - name: Check VPC Flow Logs
        run: |
          VPC_ID="${{ needs.deploy_dev.outputs.vpc_id }}"
          if [ "$VPC_ID" != "N/A" ] && [ -n "$VPC_ID" ]; then
            echo "Checking flow logs for VPC: $VPC_ID"
            FLOW_LOGS=$(aws ec2 describe-flow-logs --filter "Name=resource-id,Values=$VPC_ID" --query 'FlowLogs[0].FlowLogStatus' --output text 2>/dev/null || echo "NONE")
            echo "Flow Log Status: $FLOW_LOGS"
          fi

  # -----------------------------------
  # Notification
  # -----------------------------------
  notify:
    name: 'Send Notifications'
    runs-on: ubuntu-latest
    needs: [deploy_dev, validate_deployment]
    if: always()
    steps:
      - name: Set Deployment Status
        id: status
        run: |
          if [ "${{ needs.deploy_dev.result }}" == "success" ] && [ "${{ needs.validate_deployment.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "message=Deployment to dev completed successfully" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=Deployment to dev failed" >> $GITHUB_OUTPUT
          fi

      - name: Post Summary
        run: |
          echo "## ${{ steps.status.outputs.emoji }} Deployment Status: ${{ steps.status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Gate | ${{ needs.security_gate.result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Dev | ${{ needs.deploy_dev.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate_deployment.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Slack Notification
        if: ${{ vars.SLACK_ENABLED == 'true' }}
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "#deployments",
              "attachments": [{
                "color": "${{ steps.status.outputs.status == 'success' && 'good' || 'danger' }}",
                "title": "${{ steps.status.outputs.emoji }} AWS Secure Network - ${{ env.ENVIRONMENT }}",
                "text": "${{ steps.status.outputs.message }}",
                "fields": [
                  { "title": "Repository", "value": "${{ github.repository }}", "short": true },
                  { "title": "Branch", "value": "${{ github.ref_name }}", "short": true },
                  { "title": "Commit", "value": "${{ github.sha }}", "short": true },
                  { "title": "Actor", "value": "${{ github.actor }}", "short": true }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create GitHub Issue on Failure
        if: ${{ steps.status.outputs.status == 'failure' }}
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Deployment Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Deployment Failure Report
            
            | Item | Value |
            |------|-------|
            | Environment | ${{ env.ENVIRONMENT }} |
            | Branch | ${{ github.ref_name }} |
            | Commit | ${{ github.sha }} |
            | Actor | @${{ github.actor }} |
            | Workflow Run | [View Run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}) |
            
            ### Job Results
            | Job | Status |
            |-----|--------|
            | Security Gate | ${{ needs.security_gate.result || 'N/A' }} |
            | Deploy Dev | ${{ needs.deploy_dev.result }} |
            | Validate | ${{ needs.validate_deployment.result }} |
            
            Please investigate and resolve the issue.
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment', 'failed', 'automated']
            });

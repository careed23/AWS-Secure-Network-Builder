name: Terraform Deploy to Dev

on:
  push:
    branches:
      - main
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform-deploy.yml'

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-west-2'
  ENVIRONMENT: 'dev'

concurrency:
  group: terraform-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  security_gate:
    name: 'Pre-Deploy Security Scan'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true
          skip_check: CKV_AWS_144

  deploy_dev:
    name: 'Deploy to Dev'
    runs-on: ubuntu-latest
    needs: security_gate
    environment:
      name: dev
    outputs:
      vpc_id: ${{ steps.apply.outputs.vpc_id }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=aws-secure-network/${{ env.ENVIRONMENT }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}"

      - name: Terraform Plan
        run: terraform plan -no-color -out=tfplan -var="environment=${{ env.ENVIRONMENT }}" -var="project_name=aws-secure-network"

      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -auto-approve tfplan
          echo "vpc_id=$(terraform output -raw vpc_id 2>/dev/null || echo 'N/A')" >> $GITHUB_OUTPUT

  validate_deployment:
    name: 'Validate Deployment'
    runs-on: ubuntu-latest
    needs: deploy_dev
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate VPC
        run: |
          VPC_ID="${{ needs.deploy_dev.outputs.vpc_id }}"
          if [ "$VPC_ID" != "N/A" ]; then
            aws ec2 describe-vpcs --vpc-ids "$VPC_ID"
          fi

  notify:
    name: 'Send Notifications'
    runs-on: ubuntu-latest
    needs: [deploy_dev, validate_deployment]
    if: always()
    steps:
      - name: Post Summary
        run: |
          echo "## Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy_dev.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate_deployment.result }} |" >> $GITHUB_STEP_SUMMARY
